# Severity Criteria

コードレビュー指摘事項の重大度判定基準。

---

## 重大度定義

### Critical（致命的）

**定義**: 即座に修正が必要。マージをブロックする問題。

**基準**:
- バグを引き起こす可能性が高い
- データ損失やデータ破損の可能性
- セキュリティ脆弱性
- リソースリーク
- 本番環境での障害に直結

**アクション**: マージ前に必ず修正

**例**:

| 問題 | 理由 |
|------|------|
| Nullチェックなしの参照 | NullPointerException/TypeError を引き起こす |
| リソースリーク | メモリ/ファイルハンドル枯渇 |
| 無限ループの可能性 | システムハング |
| SQLインジェクション | セキュリティ脆弱性 |
| ミュータブルなデフォルト引数（Python） | 予期しない動作 |
| await忘れ（async/await） | 非同期処理の破綻 |
| 例外の握りつぶし（重要処理） | サイレント障害 |

### Major（重大）

**定義**: 修正すべき問題。技術的負債になる。

**基準**:
- 保守性に重大な影響
- テスト不可能な設計
- 重大なSOLID原則違反
- 将来的に問題を引き起こす可能性が高い
- アンチパターンの使用

**アクション**: このPRまたは次のスプリントで修正

**例**:

| 問題 | 理由 |
|------|------|
| God Class | 保守性の著しい低下 |
| Long Method (50行超) | 理解・テスト困難 |
| 循環依存 | アーキテクチャの劣化 |
| グローバル状態の乱用 | テスト不可能 |
| ハードコードされた依存 | テスト困難、柔軟性欠如 |
| シングルトンの乱用 | テスト困難、グローバル状態 |
| 型安全性の無視（any乱用） | バグの温床 |
| 不適切なエラーハンドリング | 障害対応困難 |

### Minor（軽微）

**定義**: 改善推奨。品質向上に寄与するが緊急ではない。

**基準**:
- 可読性の改善
- 軽微なリファクタリング機会
- ベストプラクティスからの軽微な逸脱
- 一貫性の問題

**アクション**: 時間があれば修正、または次回対応

**例**:

| 問題 | 理由 |
|------|------|
| 命名の改善余地 | 可読性向上 |
| Long Method (20-50行) | 分割推奨 |
| マジックナンバー | 定数化推奨 |
| コメントの追加が有効 | 意図の明確化 |
| Pythonic でない書き方 | Python らしくない |
| == の使用（JSで===推奨） | 厳密比較推奨 |
| フォーマットの不統一 | 一貫性向上 |

### Info（情報）

**定義**: 参考情報、ベストプラクティス提案。必須ではない。

**基準**:
- 代替アプローチの提案
- パフォーマンス改善の可能性
- より良いライブラリ/パターンの紹介
- 学習機会の提示

**アクション**: 参考情報として記録。対応は任意。

**例**:

| 問題 | 理由 |
|------|------|
| リスト内包表記が使える | Pythonic な代替案 |
| Promise.all で並列化可能 | パフォーマンス向上の可能性 |
| dataclass が使える | より良い代替案 |
| 新しいライブラリの提案 | モダンな選択肢 |

---

## 判定フローチャート

```
                    ┌────────────────────┐
                    │ 問題を検出した     │
                    └─────────┬──────────┘
                              │
                    ┌─────────▼──────────┐
                    │ バグ/セキュリティ/ │
                    │ データ損失の可能性？│
                    └─────────┬──────────┘
                              │
              ┌───────────────┴───────────────┐
              │Yes                            │No
              ▼                               ▼
     ┌────────────────┐            ┌─────────────────┐
     │   Critical     │            │ 保守性に重大な  │
     │   (致命的)     │            │ 影響？テスト    │
     └────────────────┘            │ 不可能？        │
                                   └────────┬────────┘
                                            │
                            ┌───────────────┴───────────────┐
                            │Yes                            │No
                            ▼                               ▼
                   ┌────────────────┐            ┌─────────────────┐
                   │    Major       │            │ 可読性/一貫性  │
                   │   (重大)       │            │ の改善？        │
                   └────────────────┘            └────────┬────────┘
                                                          │
                                          ┌───────────────┴───────────────┐
                                          │Yes                            │No
                                          ▼                               ▼
                                 ┌────────────────┐            ┌────────────────┐
                                 │    Minor       │            │     Info       │
                                 │   (軽微)       │            │   (情報)       │
                                 └────────────────┘            └────────────────┘
```

---

## カテゴリ別重大度ガイド

### 設計問題

| 問題 | 重大度 | 判断基準 |
|------|--------|---------|
| God Class | Major | 複数の責務、10+メソッド |
| Long Method | Minor/Major | 20-50行はMinor、50行超はMajor |
| 循環依存 | Major | アーキテクチャ劣化 |
| 密結合 | Major | 変更影響範囲が広い |
| 過度な抽象化 | Minor | 不要な複雑さ |

### テスト容易性問題

| 問題 | 重大度 | 判断基準 |
|------|--------|---------|
| グローバル状態 | Major | テスト不可能 |
| シングルトン乱用 | Major | テスト困難 |
| ハードコード依存 | Major | モック不可能 |
| 時間依存コード | Minor/Major | 抽象化の有無 |
| 副作用の多い関数 | Minor | テスト複雑化 |

### 可読性問題

| 問題 | 重大度 | 判断基準 |
|------|--------|---------|
| 暗号的な命名 | Minor | 理解困難 |
| 誤解を招く命名 | Major | バグの温床 |
| 過剰なコメント | Minor | コードで表現可能 |
| コメント不足（複雑なロジック） | Minor | 意図が不明 |
| 深いネスト | Minor | 3レベル超 |

### 言語固有問題

#### Python

| 問題 | 重大度 |
|------|--------|
| ミュータブルなデフォルト引数 | Critical |
| 裸のexcept | Major |
| 型ヒントの欠如 | Minor |
| 非Pythonic | Info |

#### JavaScript/TypeScript

| 問題 | 重大度 |
|------|--------|
| await忘れ | Critical |
| anyの乱用 | Major |
| ==の使用 | Minor |
| varの使用 | Minor |

---

## 重大度の調整要因

### 重大度を上げる要因

```
+ クリティカルパスにある
+ 頻繁に実行されるコード
+ 本番環境に直結
+ セキュリティに関わる
+ データ整合性に関わる
+ 修正が困難になる前
```

### 重大度を下げる要因

```
- プロトタイプ/POC
- テストコード
- 廃止予定のコード
- 一時的なワークアラウンド（期限付き）
- 影響範囲が限定的
```

---

## マージ可否判定

### Ready（マージ可能）

```
条件:
- Critical: 0件
- Major: 0件、または軽微で影響が限定的
- Minor/Info: 任意
```

### Conditional（条件付き可能）

```
条件:
- Critical: 0件
- Major: 数件だが、すぐに対応予定

必要なアクション:
- 対応チケットの作成
- 期限の設定
- オーナーの割り当て
```

### Not Ready（マージ不可）

```
条件:
- Critical: 1件以上
- または Major が多数
- または 全体的な品質が基準以下

必要なアクション:
- 問題の修正
- 再レビュー依頼
```

---

## 重大度判定のベストプラクティス

### Do（すべきこと）

```
✓ コンテキストを考慮する
✓ 影響範囲を評価する
✓ 将来のリスクを考える
✓ チームの基準に合わせる
✓ 一貫性を保つ
```

### Don't（すべきでないこと）

```
✗ すべてをCriticalにする
✗ すべてをInfoにする
✗ 感情的に判断する
✗ 個人の好みで判断する
✗ コンテキストを無視する
```
